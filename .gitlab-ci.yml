stages:
  - prep
  - test

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  CARGO_INCREMENTAL: "0"
  ZED_EXT_DIR: extensions/zed

## RULES ======================================================================

.zed-rules-ci: &zed-rules-ci
  - if: $CI_MERGE_REQUEST_ID
    changes:
      compare_to: refs/heads/main
      paths:
        - extensions/zed/Cargo.lock
        - extensions/zed/Cargo.toml
        - extensions/zed/src/**/*
        - extensions/zed/tests/**/*
  - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
    changes:
      paths:
        - extensions/zed/Cargo.lock
        - extensions/zed/Cargo.toml
        - extensions/zed/src/**/*
        - extensions/zed/tests/**/*

## JOBS ========================================================================
test:
  stage: test
  parallel:
    matrix:
      - LIBC: linux-x86_64-glibc
        BUILD_IMAGE: lang/rust-debian:20260123-b1.88-slim-trixie
      - LIBC: linux-x86_64-musl
        BUILD_IMAGE: lang/rust-alpine:20260123-b1.88-alpine3.22
  image: registry.gitlab.com/rhobimd-oss/cicd/${BUILD_IMAGE}
  interruptible: true
  timeout: 10m
  rules: *zed-rules-ci
  script:
    - |
      set -euo pipefail
      cd ${ZED_EXT_DIR}

      echo "=== Toolchain versions ==="
      rustc --version
      cargo --version

      echo "=== Integration tests ${LIBC} ==="
      cargo test --test github_release -- --ignored --test-threads=1
  cache:
    key: zed-ext-deps
    paths:
      - .cargo/registry/cache/
      - .cargo/registry/index/
      - .cargo/git/db/
